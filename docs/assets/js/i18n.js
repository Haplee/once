window.allTranslations = {
    "es": {
        "appTitle": "Calculadora de Cambio - ONCE App",
        "historyPageTitle": "Historial de Operaciones - ONCE App",
        "settingsPageTitle": "Configuración - ONCE App",
        "navCalculator": "Calculadora",
        "navHistory": "Historial",
        "navSettings": "Configuración",
        "calculatorTitle": "Calculadora de Cambio",
        "totalToPayLabel": "Total a Pagar (€)",
        "totalToPayPlaceholder": "Ej: 5.50",
        "amountReceivedLabel": "Importe Recibido (€)",
        "amountReceivedPlaceholder": "Ej: 10.00",
        "calculateButton": "Calcular",
        "voiceInputButtonLabel": "Usar entrada de voz",
        "voiceErrorPermission": "Acceso al micrófono denegado. Para usar esta función, por favor, permite el acceso al micrófono en tu navegador.",
        "voiceErrorNoSpeech": "No se ha detectado ninguna voz. Inténtalo de nuevo hablando cerca del micrófono.",
        "voiceErrorInfo": "Error de reconocimiento: {error}. Por favor, inténtalo de nuevo.",
        "voiceErrorTimeout": "El reconocimiento de voz se detuvo por inactividad.",
        "voiceErrorStart": "No se pudo iniciar el reconocimiento. Asegúrate de que el micrófono esté permitido y no esté en uso.",
        "voiceErrorUnsupported": "Lo sentimos, tu navegador no es compatible con el reconocimiento de voz.",
        "changeResultText": "El cambio a devolver es: {change} €",
        "invalidInputText": "Por favor, introduce importes válidos.",
        "amountReceivedLowText": "El importe recibido es menor que el total a pagar.",
        "historyTitle": "Historial de Operaciones",
        "historyHeaderDate": "Fecha y Hora",
        "historyHeaderTotal": "Total Pagado",
        "historyHeaderReceived": "Importe Recibido",
        "historyHeaderChange": "Cambio Devuelto",
        "settingsTitle": "Configuración",
        "settingsDarkModeLabel": "Modo Oscuro",
        "settingsLanguageLabel": "Idioma",
        "settingsLangSpanish": "Español",
        "settingsLangEnglish": "Inglés",
        "settingsLangGalician": "Gallego",
        "settingsLangCatalan": "Catalán",
        "settingsLangValencian": "Valenciano",
        "settingsLangBasque": "Euskera",
        "settingsSerialTitle": "Comunicación con Dispositivo Externo",
        "settingsSerialDescription": "Conecta un dispositivo por USB para enviar y recibir datos.",
        "settingsMachineModelLabel": "Modelo de Máquina",
        "settingsMachineModelS": "Modelo S (Básico)",
        "settingsMachineModelM": "Modelo M (Estándar)",
        "settingsMachineModelMax": "Modelo MAX (Completo)",
        "settingsSerialConnect": "Conectar Dispositivo",
        "settingsSerialSend": "Enviar",
        "settingsSerialPlaceholder": "Escribe un comando...",
        "settingsSerialConsoleLabel": "Consola de comunicación",
        "speechEuroSingular": "euro",
        "speechEuroPlural": "euros",
        "speechCentSingular": "céntimo",
        "speechCentPlural": "céntimos",
        "speechCon": "con",
        "speechCero": "cero",
        "speechOneEuro": "un euro",
        "speechOneCent": "un céntimo",
        "speechChangeResultText": "El cambio a devolver es:"
    },
    "en": {
        "appTitle": "Change Calculator - ONCE App",
        "historyPageTitle": "Transaction History - ONCE App",
        "settingsPageTitle": "Settings - ONCE App",
        "navCalculator": "Calculator",
        "navHistory": "History",
        "navSettings": "Settings",
        "calculatorTitle": "Change Calculator",
        "totalToPayLabel": "Total to Pay (€)",
        "totalToPayPlaceholder": "e.g., 5.50",
        "amountReceivedLabel": "Amount Received (€)",
        "amountReceivedPlaceholder": "e.g., 10.00",
        "calculateButton": "Calculate",
        "voiceInputButtonLabel": "Use voice input",
        "voiceErrorPermission": "Microphone access denied. To use this feature, please allow microphone access in your browser.",
        "voiceErrorNoSpeech": "No speech was detected. Try again, speaking clearly near the microphone.",
        "voiceErrorInfo": "Recognition error: {error}. Please try again.",
        "voiceErrorTimeout": "Voice recognition timed out due to inactivity.",
        "voiceErrorStart": "Could not start recognition. Make sure the microphone is allowed and not in use.",
        "voiceErrorUnsupported": "Sorry, your browser does not support voice recognition.",
        "changeResultText": "The change to return is: {change} €",
        "invalidInputText": "Please enter valid amounts.",
        "amountReceivedLowText": "The amount received is less than the total to pay.",
        "historyTitle": "Transaction History",
        "historyHeaderDate": "Date and Time",
        "historyHeaderTotal": "Total Paid",
        "historyHeaderReceived": "Amount Received",
        "historyHeaderChange": "Change Returned",
        "settingsTitle": "Settings",
        "settingsDarkModeLabel": "Dark Mode",
        "settingsLanguageLabel": "Language",
        "settingsLangSpanish": "Spanish",
        "settingsLangEnglish": "English",
        "settingsLangGalician": "Galician",
        "settingsLangCatalan": "Catalan",
        "settingsLangValencian": "Valencian",
        "settingsLangBasque": "Basque",
        "settingsSerialTitle": "External Device Communication",
        "settingsSerialDescription": "Connect a device via USB to send and receive data.",
        "settingsMachineModelLabel": "Machine Model",
        "settingsMachineModelS": "Model S (Basic)",
        "settingsMachineModelM": "Model M (Standard)",
        "settingsMachineModelMax": "Model MAX (Complete)",
        "settingsSerialConnect": "Connect Device",
        "settingsSerialSend": "Send",
        "settingsSerialPlaceholder": "Type a command...",
        "settingsSerialConsoleLabel": "Communication console",
        "speechEuroSingular": "euro",
        "speechEuroPlural": "euros",
        "speechCentSingular": "cent",
        "speechCentPlural": "cents",
        "speechCon": "with",
        "speechCero": "zero",
        "speechOneEuro": "one euro",
        "speechOneCent": "one cent",
        "speechChangeResultText": "The change to return is:"
    },
    "gl": {
        "appTitle": "Calculadora de Troco - ONCE App",
        "historyPageTitle": "Historial de Operacións - ONCE App",
        "settingsPageTitle": "Configuración - ONCE App",
        "navCalculator": "Calculadora",
        "navHistory": "Historial",
        "navSettings": "Configuración",
        "calculatorTitle": "Calculadora de troco",
        "totalToPayLabel": "Total a pagar (€)",
        "totalToPayPlaceholder": "Ex: 5.50",
        "amountReceivedLabel": "Importe recibido (€)",
        "amountReceivedPlaceholder": "Ex: 10.00",
        "calculateButton": "Calcular",
        "voiceInputButtonLabel": "Usar entrada de voz",
        "voiceErrorPermission": "Acceso ao micrófono denegado. Para usar esta función, permite o acceso ao micrófono no teu navegador.",
        "voiceErrorNoSpeech": "Non se detectou ningunha voz. Téntao de novo falando preto do micrófono.",
        "voiceErrorInfo": "Erro de recoñecemento: {error}. Por favor, téntao de novo.",
        "voiceErrorTimeout": "O recoñecemento de voz detívose por inactividade.",
        "voiceErrorStart": "Non se puido iniciar o recoñecemento. Asegúrate de que o micrófono estea permitido e non estea en uso.",
        "voiceErrorUnsupported": "O teu navegador non é compatible co recoñecemento de voz.",
        "changeResultText": "O troco a devolver é: {change} €",
        "invalidInputText": "Por favor, introduce importes válidos.",
        "amountReceivedLowText": "O importe recibido é menor que o total a pagar.",
        "historyTitle": "Historial de operacións",
        "historyHeaderDate": "Data e Hora",
        "historyHeaderTotal": "Total pagado",
        "historyHeaderReceived": "Importe recibido",
        "historyHeaderChange": "Troco devolto",
        "settingsTitle": "Configuración",
        "settingsDarkModeLabel": "Modo escuro",
        "settingsLanguageLabel": "Idioma",
        "settingsLangSpanish": "Español",
        "settingsLangEnglish": "Inglés",
        "settingsLangGalician": "Galego",
        "settingsLangCatalan": "Catalán",
        "settingsLangValencian": "Valenciano",
        "settingsLangBasque": "Éuscaro",
        "settingsSerialTitle": "Comunicación con dispositivo externo",
        "settingsSerialDescription": "Conecta un dispositivo por USB para enviar e recibir datos.",
        "settingsMachineModelLabel": "Modelo de máquina",
        "settingsMachineModelS": "Modelo S (Básico)",
        "settingsMachineModelM": "Modelo M (Estándar)",
        "settingsMachineModelMax": "Modelo MAX (Completo)",
        "settingsSerialConnect": "Conectar dispositivo",
        "settingsSerialSend": "Enviar",
        "settingsSerialPlaceholder": "Escribe un comando...",
        "settingsSerialConsoleLabel": "Consola de comunicación",
        "speechEuroSingular": "euro",
        "speechEuroPlural": "euros",
        "speechCentSingular": "céntimo",
        "speechCentPlural": "céntimos",
        "speechCon": "con",
        "speechCero": "cero",
        "speechOneEuro": "un euro",
        "speechOneCent": "un céntimo",
        "speechChangeResultText": "O troco a devolver é:"
    },
    "ca": {
        "appTitle": "Calculadora de Canvi - ONCE App",
        "historyPageTitle": "Historial d'Operacions - ONCE App",
        "settingsPageTitle": "Configuració - ONCE App",
        "navCalculator": "Calculadora",
        "navHistory": "Historial",
        "navSettings": "Configuració",
        "calculatorTitle": "Calculadora de Canvi",
        "totalToPayLabel": "Total a Pagar (€)",
        "totalToPayPlaceholder": "Ex: 5.50",
        "amountReceivedLabel": "Import Rebut (€)",
        "amountReceivedPlaceholder": "Ex: 10.00",
        "calculateButton": "Calcular",
        "voiceInputButtonLabel": "Utilisar entrada de veu",
        "voiceErrorPermission": "Accés al micròfon denegat. Per a utilisar esta funció, per favor, permet l'accés al micròfon en el teu navegador.",
        "voiceErrorNoSpeech": "No s'ha detectat cap veu. Intenta-ho de nou parlant prop del micròfon.",
        "voiceErrorInfo": "Error de reconeixement: {error}. Per favor, intenta-ho de nou.",
        "voiceErrorTimeout": "El reconeixement de veu es va detindre per inactivitat.",
        "voiceErrorStart": "No s'ha pogut iniciar el reconeixement. Assegura't que el micròfon estiga permés i no estiga en ús.",
        "voiceErrorUnsupported": "Ho sentim, el teu navegador no és compatible amb el reconeixement de veu.",
        "changeResultText": "El canvi a tornar és: {change} €",
        "invalidInputText": "Per favor, introduïx imports vàlids.",
        "amountReceivedLowText": "L'import rebut és menor que el total a pagar.",
        "historyTitle": "Historial d'Operacions",
        "historyHeaderDate": "Data i Hora",
        "historyHeaderTotal": "Total Pagat",
        "historyHeaderReceived": "Import Rebut",
        "historyHeaderChange": "Canvi Tornat",
        "settingsTitle": "Configuració",
        "settingsDarkModeLabel": "Mode Fosc",
        "settingsLanguageLabel": "Idioma",
        "settingsLangSpanish": "Espanyol",
        "settingsLangEnglish": "Anglés",
        "settingsLangGalician": "Gallec",
        "settingsLangCatalan": "Català",
        "settingsLangValencian": "Valencià",
        "settingsLangBasque": "Basc",
        "settingsSerialTitle": "Comunicació amb Dispositiu Extern",
        "settingsSerialDescription": "Connecta un dispositiu per USB per a enviar i rebre dades.",
        "settingsMachineModelLabel": "Model de Màquina",
        "settingsMachineModelS": "Model S (Bàsic)",
        "settingsMachineModelM": "Model M (Estàndard)",
        "settingsMachineModelMax": "Model MAX (Complet)",
        "settingsSerialConnect": "Connectar Dispositiu",
        "settingsSerialSend": "Enviar",
        "settingsSerialPlaceholder": "Escriu una orde...",
        "settingsSerialConsoleLabel": "Consola de comunicació",
        "speechEuroSingular": "euro",
        "speechEuroPlural": "euros",
        "speechCentSingular": "cèntim",
        "speechCentPlural": "cèntims",
        "speechCon": "amb",
        "speechCero": "zero",
        "speechOneEuro": "un euro",
        "speechOneCent": "un cèntim",
        "speechChangeResultText": "El canvi a tornar és:"
    },
    "va": {
        "appTitle": "Calculadora de Canvi - ONCE App",
        "historyPageTitle": "Historial d'Operacions - ONCE App",
        "settingsPageTitle": "Configuració - ONCE App",
        "navCalculator": "Calculadora",
        "navHistory": "Historial",
        "navSettings": "Configuració",
        "calculatorTitle": "Calculadora de Canvi",
        "totalToPayLabel": "Total a Pagar (€)",
        "totalToPayPlaceholder": "Ex: 5.50",
        "amountReceivedLabel": "Import Rebut (€)",
        "amountReceivedPlaceholder": "Ex: 10.00",
        "calculateButton": "Calcular",
        "voiceInputButtonLabel": "Utilitzar entrada de veu",
        "voiceErrorPermission": "Accés al micròfon denegat. Per utilitzar aquesta funció, si us plau, permet l'accés al micròfon al teu navegador.",
        "voiceErrorNoSpeech": "No s'ha detectat cap veu. Intenta-ho de nou parlant a prop del micròfon.",
        "voiceErrorInfo": "Error de reconeixement: {error}. Si us plau, intenta-ho de nou.",
        "voiceErrorTimeout": "El reconeixement de veu es va aturar per inactivitat.",
        "voiceErrorStart": "No s'ha pogut iniciar el reconeixement. Assegura't que el micròfon estigui permès i no estigui en ús.",
        "voiceErrorUnsupported": "Ho sentim, el teu navegador no és compatible amb el reconeixement de veu.",
        "changeResultText": "El canvi a tornar és: {change} €",
        "invalidInputText": "Si us plau, introdueix imports vàlids.",
        "amountReceivedLowText": "L'import rebut és menor que el total a pagar.",
        "historyTitle": "Historial d'Operacions",
        "historyHeaderDate": "Data i Hora",
        "historyHeaderTotal": "Total Pagat",
        "historyHeaderReceived": "Import Rebut",
        "historyHeaderChange": "Canvi Tornat",
        "settingsTitle": "Configuració",
        "settingsDarkModeLabel": "Mode Fosc",
        "settingsLanguageLabel": "Idioma",
        "settingsLangSpanish": "Espanyol",
        "settingsLangEnglish": "Anglès",
        "settingsLangGalician": "Gallec",
        "settingsLangCatalan": "Català",
        "settingsLangValencian": "Valencià",
        "settingsLangBasque": "Basc",
        "settingsSerialTitle": "Comunicació amb Dispositiu Extern",
        "settingsSerialDescription": "Connecta un dispositiu per USB per enviar i rebre dades.",
        "settingsMachineModelLabel": "Model de Màquina",
        "settingsMachineModelS": "Model S (Bàsic)",
        "settingsMachineModelM": "Model M (Estàndard)",
        "settingsMachineModelMax": "Model MAX (Complet)",
        "settingsSerialConnect": "Connectar Dispositu",
        "settingsSerialSend": "Enviar",
        "settingsSerialPlaceholder": "Escriu una ordre...",
        "settingsSerialConsoleLabel": "Consola de comunicació",
        "speechEuroSingular": "euro",
        "speechEuroPlural": "euros",
        "speechCentSingular": "cèntim",
        "speechCentPlural": "cèntims",
        "speechCon": "amb",
        "speechCero": "zero",
        "speechOneEuro": "un euro",
        "speechOneCent": "un cèntim",
        "speechChangeResultText": "El canvi a tornar és:"
    },
    "eu": {
        "appTitle": "Aldaketa Kalkulagailua - ONCE App",
        "historyPageTitle": "Eragiketen Historiala - ONCE App",
        "settingsPageTitle": "Ezarpenak - ONCE App",
        "navCalculator": "Kalkulagailua",
        "navHistory": "Historiala",
        "navSettings": "Ezarpenak",
        "calculatorTitle": "Aldaketa Kalkulagailua",
        "totalToPayLabel": "Ordaindu beharreko totala (€)",
        "totalToPayPlaceholder": "Adib: 5.50",
        "amountReceivedLabel": "Jasotako zenbatekoa (€)",
        "amountReceivedPlaceholder": "Adib: 10.00",
        "calculateButton": "Kalkulatu",
        "voiceInputButtonLabel": "Ahots bidezko sarrera erabili",
        "voiceErrorPermission": "Mikrofonoaren sarbidea ukatuta. Funtzio hau erabiltzeko, mesedez, baimendu mikrofonoaren sarbidea zure nabigatzailean.",
        "voiceErrorNoSpeech": "Ez da ahotsik detektatu. Saiatu berriro mikrofonotik hurbil hitz egiten.",
        "voiceErrorInfo": "Aintzatespen errorea: {error}. Mesedez, saiatu berriro.",
        "voiceErrorTimeout": "Ahotsaren aintzatespena gelditu da inaktibitateagatik.",
        "voiceErrorStart": "Ezin izan da aintzatespena hasi. Ziurtatu mikrofonoa baimenduta dagoela eta ez dagoela erabiltzen.",
        "voiceErrorUnsupported": "Sentitzen dugu, zure nabigatzaileak ez du ahotsaren aintzatespena onartzen.",
        "changeResultText": "Itzuli beharreko aldaketa hau da: {change} €",
        "invalidInputText": "Mesedez, sartu zenbateko baliodunak.",
        "amountReceivedLowText": "Jasotako zenbatekoa ordaindu beharrekoa baino txikiagoa da.",
        "historyTitle": "Eragiketen Historiala",
        "historyHeaderDate": "Data eta Ordua",
        "historyHeaderTotal": "Ordaindutako totala",
        "historyHeaderReceived": "Jasotako zenbatekoa",
        "historyHeaderChange": "Itzulitako aldaketa",
        "settingsTitle": "Ezarpenak",
        "settingsDarkModeLabel": "Modu Iluna",
        "settingsLanguageLabel": "Hizkuntza",
        "settingsLangSpanish": "Gaztelania",
        "settingsLangEnglish": "Ingelesa",
        "settingsLangGalician": "Galiziera",
        "settingsLangCatalan": "Katalana",
        "settingsLangValencian": "Valentziera",
        "settingsLangBasque": "Euskara",
        "settingsSerialTitle": "Kanpoko Gailuarekin Komunikazioa",
        "settingsSerialDescription": "Konektatu gailu bat USB bidez datuak bidaltzeko eta jasotzeko.",
        "settingsMachineModelLabel": "Makina Eredua",
        "settingsMachineModelS": "S Eredua (Oinarrizkoa)",
        "settingsMachineModelM": "M Eredua (Estandarra)",
        "settingsMachineModelMax": "MAX Eredua (Osoa)",
        "settingsSerialConnect": "Gailua Konektatu",
        "settingsSerialSend": "Bidali",
        "settingsSerialPlaceholder": "Idatzi komando bat...",
        "settingsSerialConsoleLabel": "Komunikazio kontsola",
        "speechEuroSingular": "euro",
        "speechEuroPlural": "euro",
        "speechCentSingular": "zentimo",
        "speechCentPlural": "zentimo",
        "speechCon": "eta",
        "speechCero": "zero",
        "speechOneEuro": "euro bat",
        "speechOneCent": "zentimo bat",
        "speechChangeResultText": "Itzuli beharreko aldaketa hau da:"
    }
};

/**
 * @type {Object.<string, string>}
 * @description Holds the translations for the currently selected language.
 */
let currentTranslations = {};

/**
 * Retrieves the current language from localStorage or defaults to Spanish ('es').
 * @returns {string} The current language code (e.g., 'es', 'en').
 */
const getCurrentLanguage = () => {
    return localStorage.getItem('language') || 'es';
};

/**
 * Loads the translation dictionary for a given language.
 * Falls back to Spanish if the specified language is not found.
 * @param {string} lang - The language code to load (e.g., 'es').
 */
const loadTranslations = (lang) => {
    currentTranslations = allTranslations[lang] || allTranslations['es'];
    window.currentTranslations = currentTranslations;
};

/**
 * Traverses the DOM and replaces the content of elements with i18n keys
 * with the corresponding translations from the loaded dictionary.
 */
const translatePage = () => {
    // Translate text content
    document.querySelectorAll('[data-i18n-key]').forEach(element => {
        const key = element.getAttribute('data-i18n-key');
        element.textContent = currentTranslations[key] || key;
    });
    // Translate placeholder attributes
    document.querySelectorAll('[data-i18n-placeholder-key]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder-key');
        element.placeholder = currentTranslations[key] || key;
    });
    // Translate ARIA labels for accessibility
    document.querySelectorAll('[data-i18n-aria-key]').forEach(element => {
        const key = element.getAttribute('data-i18n-aria-key');
        element.setAttribute('aria-label', currentTranslations[key] || key);
    });
    // Translate the page title
    const pageKey = document.body.dataset.pageKey;
    if (pageKey && currentTranslations[pageKey]) {
        document.title = currentTranslations[pageKey];
    }
};

/**
 * Initializes the internationalization process on page load.
 * It identifies the current language, loads the translations, and translates the page.
 */
const initializeI18n = () => {
    const lang = getCurrentLanguage();
    loadTranslations(lang);
    translatePage();
};

/**
 * Identifies the current HTML page and sets a data attribute on the body
 * with a corresponding key for title translation.
 */
const identifyPage = () => {
    const path = window.location.pathname.split("/").pop();
    let pageKey = '';
    if (path.includes('index.html') || path === '') {
        pageKey = 'appTitle';
    } else if (path.includes('login.html')) {
        pageKey = 'loginPageTitle';
    } else if (path.includes('history.html')) {
        pageKey = 'historyPageTitle';
    } else if (path.includes('configuracion.html')) {
        pageKey = 'settingsPageTitle';
    }
    document.body.dataset.pageKey = pageKey;
};


// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    identifyPage();
    initializeI18n();
});

/**
 * Sets the application's language, stores it in localStorage, and re-initializes
 * the internationalization process to apply the new language.
 * This function is exposed globally so it can be called from other scripts.
 * @param {string} lang - The language code to set (e.g., 'en').
 * @returns {Promise<void>} A promise that resolves when the language is set and applied.
 */
window.setLanguage = async (lang) => {
    localStorage.setItem('language', lang);
    initializeI18n();
};
