{% extends "base.html" %}

{% block title %}{{ _('historyPageTitle') }}{% endblock %}

{% block content %}
<div class="glass-panel" style="padding: 2rem;">
    <h1 data-i18n-key="historyTitle">{{ _('historyTitle') }}</h1>

    <div class="table-container">
        <table id="history-table">
            <thead>
                <tr>
                    <th data-i18n-key="historyHeaderDate">{{ _('historyHeaderDate') }}</th>
                    <th data-i18n-key="historyHeaderTotal">{{ _('historyHeaderTotal') }}</th>
                    <th data-i18n-key="historyHeaderReceived">{{ _('historyHeaderReceived') }}</th>
                    <th data-i18n-key="historyHeaderChange">{{ _('historyHeaderChange') }}</th>
                </tr>
            </thead>
            <tbody>
                <!-- Contenido cargado dinámicamente -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const tableBody = document.querySelector('#history-table tbody');
        const trans = window.currentTranslations || {};
        try {
            const response = await fetch('/api/history');
            if (!response.ok) throw new Error('Failed to fetch history');
            const data = await response.json();

            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center">${trans.noHistory || 'No hay registros'}</td></tr>`;
                return;
            }

            tableBody.innerHTML = data.map(item => `
            <tr>
                <td>${new Date(item.timestamp).toLocaleString()}</td>
                <td>€ ${item.total_amount.toFixed(2)}</td>
                <td>€ ${item.amount_received.toFixed(2)}</td>
                <td><strong>€ ${item.change_returned.toFixed(2)}</strong></td>
            </tr>
        `).join('');
        } catch (err) {
            console.error('Error fetching history:', err);
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center">${trans.historyLoadError || 'Error al cargar el historial'}</td></tr>`;
        }
    });
</script>
{% endblock %}